rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===========================
    // ğŸ” HELPER FUNCTIONS
    // ===========================
    
    // Check if user is admin
    function isAdmin(uid) {
      return exists(/databases/$(database)/documents/users/$(uid)) &&
             get(/databases/$(database)/documents/users/$(uid)).data.role == 'admin';
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user owns the resource
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // ===========================
    // ğŸ‘¤ USERS COLLECTION
    // ===========================
    match /users/{userId} {
      // ğŸ“– READ: Users can read their own profile. Admins can read all.
      allow read: if isAuthenticated() && (isOwner(userId) || isAdmin(request.auth.uid));
      
      // âœï¸ WRITE: Users can only create/update their own data. Prevent role changes.
      allow create: if isOwner(userId) && 
                       request.resource.data.role == 'user' &&
                       request.resource.data.uid == userId &&
                       request.resource.data.email == request.auth.token.email;
      
      allow update: if isOwner(userId) && 
                       request.resource.data.role == resource.data.role && // ğŸš« Cannot change role
                       request.resource.data.uid == resource.data.uid &&     // ğŸš« Cannot change uid
                       request.resource.data.email == resource.data.email;   // ğŸš« Cannot change email
      
      // ğŸ—‘ï¸ DELETE: Only admins can delete users
      allow delete: if isAdmin(request.auth.uid);
    }
    
    // ===========================
    // ğŸ“‹ LOST_ITEMS COLLECTION
    // ===========================
    match /lost_items/{itemId} {
      // ğŸ“– READ: Everyone can read lost items (to find matches)
      allow read: if true;
      
      // âœï¸ CREATE: Only authenticated users can report lost items (status must start as 'pending')
      allow create: if isAuthenticated() && 
               request.resource.data.userId == request.auth.uid &&
               request.resource.data.status == 'pending';
      
      // âœï¸ UPDATE: Item owner can update their own items (until resolved). Admins can always update.
      allow update: if isAuthenticated() && 
                       (
                         (isOwner(resource.data.userId) && resource.data.status != 'resolved') ||
                         isAdmin(request.auth.uid)
                       );
      
      // ğŸ—‘ï¸ DELETE: Item owner can delete (until resolved). Admins can always delete.
      allow delete: if isAuthenticated() && 
                       (
                         (isOwner(resource.data.userId) && resource.data.status != 'resolved') ||
                         isAdmin(request.auth.uid)
                       );
    }
    
    // ===========================
    // ğŸ“¦ FOUND_ITEMS COLLECTION
    // ===========================
    match /found_items/{itemId} {
      // ğŸ“– READ: Everyone can read found items
      allow read: if true;
      
      // âœï¸ CREATE: Only authenticated users can report found items (status must start as 'available')
      allow create: if isAuthenticated() && 
               request.resource.data.userId == request.auth.uid &&
               request.resource.data.status == 'available';
      
      // âœï¸ UPDATE: Item reporter can update (until resolved). Admins can always update.
      allow update: if isAuthenticated() && 
                       (
                         (isOwner(resource.data.userId) && resource.data.status != 'resolved') ||
                         isAdmin(request.auth.uid)
                       );
      
      // ğŸ—‘ï¸ DELETE: Item reporter can delete (until resolved). Admins can always delete.
      allow delete: if isAuthenticated() && 
                       (
                         (isOwner(resource.data.userId) && resource.data.status != 'resolved') ||
                         isAdmin(request.auth.uid)
                       );
    }
    
    // ===========================
    // ğŸ“ CLAIMS COLLECTION
    // ===========================
    match /claims/{claimId} {
      // ğŸ“– READ: Admins can read all claims. Claimant or item owner can read related claims.
      allow read: if isAuthenticated() && (
        isAdmin(request.auth.uid) ||
        request.auth.uid == resource.data.claimantUserId ||
        (
          resource.data.itemType == 'lost' && exists(/databases/$(database)/documents/lost_items/$(resource.data.itemId)) &&
          get(/databases/$(database)/documents/lost_items/$(resource.data.itemId)).data.userId == request.auth.uid
        ) ||
        (
          resource.data.itemType == 'found' && exists(/databases/$(database)/documents/found_items/$(resource.data.itemId)) &&
          get(/databases/$(database)/documents/found_items/$(resource.data.itemId)).data.userId == request.auth.uid
        )
      );

      // âœï¸ CREATE: Only authenticated users can create their own claim and status must be 'requested'
      allow create: if isAuthenticated() &&
                      request.resource.data.claimantUserId == request.auth.uid &&
                      request.resource.data.status == 'requested' &&
                      request.resource.data.itemId is string &&
                      request.resource.data.itemType in ['lost','found'];

      // âœï¸ UPDATE: Only admins can change claim status. Claimant can update message while status is 'requested'.
      allow update: if isAuthenticated() && (
        isAdmin(request.auth.uid) ||
        (
          request.auth.uid == resource.data.claimantUserId &&
          resource.data.status == 'requested'
        )
      );

      // ğŸ—‘ï¸ DELETE: Claimant can delete their own claim when status is 'requested'. Admins can delete any claim.
      allow delete: if isAuthenticated() && (
        isAdmin(request.auth.uid) ||
        (request.auth.uid == resource.data.claimantUserId && resource.data.status == 'requested')
      );
    }

    // ===========================
    // ğŸ’¬ CONTACT_MESSAGES COLLECTION
    // ===========================
    match /contactMessages/{messageId} {
      // ğŸ“– READ: Only admins can read contact messages
      allow read: if isAuthenticated() && isAdmin(request.auth.uid);
      
      // âœï¸ CREATE: Anyone (even unauthenticated) can send a message
      allow create: if true;
      
      // âœï¸ UPDATE: Only admins can update
      allow update: if isAuthenticated() && isAdmin(request.auth.uid);
      
      // ğŸ—‘ï¸ DELETE: Only admins can delete
      allow delete: if isAuthenticated() && isAdmin(request.auth.uid);
    }
  }
}
